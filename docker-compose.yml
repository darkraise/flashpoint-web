version: '3.8'

services:
  # Backend API Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: flashpoint-backend:latest
    container_name: flashpoint-backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-3100}:3100"
    volumes:
      # Flashpoint data (read-only)
      - ${FLASHPOINT_HOST_PATH:?FLASHPOINT_HOST_PATH environment variable must be set}:/data/flashpoint:ro
      # User database (persistent)
      - backend-db:/app/data
      # Application logs (persistent)
      # Set BACKEND_LOGS_PATH to bind-mount a host directory
      - ${BACKEND_LOGS_PATH:-backend-logs}:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-UTC}
      - PORT=3100
      - HOST=0.0.0.0
      # Flashpoint base path (all other paths derived automatically by backend)
      - FLASHPOINT_PATH=/data/flashpoint
      # Game service connection (Docker network)
      - GAME_SERVICE_HOST=game-service
      - GAME_SERVICE_PROXY_PORT=22500
      - GAME_SERVICE_GAMEZIP_PORT=22501
      # External services
      - EXTERNAL_IMAGE_URLS=${EXTERNAL_IMAGE_URLS:-https://infinity.flashpointarchive.org/Flashpoint/Data/Images,https://infinity.unstable.life/Flashpoint/Data/Images}
      - DOMAIN=${DOMAIN:-http://localhost:${WEB_PORT:-80}}
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FILE=${LOG_FILE:-/app/logs/backend.log}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET environment variable must be set}
      - USER_DB_PATH=/app/data/user.db
    depends_on:
      game-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3100/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - flashpoint-network

  # Game Service (Proxy and ZIP Server)
  game-service:
    build:
      context: ./game-service
      dockerfile: Dockerfile
    image: flashpoint-game-service:latest
    container_name: flashpoint-game-service
    restart: unless-stopped
    ports:
      - "${PROXY_PORT:-22500}:22500"      # Proxy server
      - "${GAMEZIP_PORT:-22501}:22501"    # GameZip server
    volumes:
      - ${FLASHPOINT_HOST_PATH:?FLASHPOINT_HOST_PATH environment variable must be set}:/data/flashpoint:ro
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-UTC}
      - PROXY_PORT=22500
      - GAMEZIPSERVER_PORT=22501
      # Flashpoint base path (all other paths derived automatically)
      - FLASHPOINT_PATH=/data/flashpoint
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:22500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - flashpoint-network

  # Frontend Service (Nginx serving built files)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:${API_PORT:-3100}
    image: flashpoint-frontend:latest
    container_name: flashpoint-frontend
    restart: unless-stopped
    environment:
      - TZ=${TZ:-UTC}
      - BACKEND_HOST=${BACKEND_HOST:-backend}
      - BACKEND_PORT=${BACKEND_PORT:-3100}
    ports:
      - "${WEB_PORT:-80}:8080"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - flashpoint-network

networks:
  flashpoint-network:
    driver: bridge

volumes:
  # Persistent volume for user database
  backend-db:
    driver: local
  # Persistent volume for backend logs
  backend-logs:
    driver: local

# =============================================================================
# Flashpoint Web App - Docker Compose Configuration
# =============================================================================
#
# This configuration runs all three services:
# - backend: REST API (port 3100)
# - game-service: Proxy and ZIP server (ports 22500, 22501)
# - frontend: Web UI (port 80)
#
# Usage:
# ------
# 1. Configure environment variables:
#    cp .env.example .env
#    # Edit .env and set FLASHPOINT_HOST_PATH and JWT_SECRET (REQUIRED)
#    # Optionally customize other settings (see .env.example for all options)
#
# 2. Build all services:
#    docker-compose build
#
# 3. Start all services:
#    docker-compose up -d
#
# 4. Start specific services:
#    docker-compose up -d backend game-service
#
# 5. View logs:
#    # Console logs (docker-compose)
#    docker-compose logs -f
#    docker-compose logs -f backend
#    docker-compose logs -f game-service
#
#    # File logs (persistent in volume)
#    docker exec flashpoint-backend cat /app/logs/backend.log
#    docker exec flashpoint-backend tail -f /app/logs/backend.log
#
#    # Access log volume location on host
#    docker volume inspect flashpoint-web_backend-logs
#
# 6. Stop all services:
#    docker-compose down
#
# 7. Rebuild and restart:
#    docker-compose up -d --build
#
# Access:
# -------
# - Frontend: http://localhost:${WEB_PORT} (default: http://localhost)
# - Backend API: http://localhost:${API_PORT} (default: http://localhost:3100)
# - Game Proxy: http://localhost:${PROXY_PORT} (default: http://localhost:22500)
# - GameZip: http://localhost:${GAMEZIP_PORT} (default: http://localhost:22501)
#
# Environment Variables:
# ----------------------
# See .env.example for all configurable environment variables and their descriptions.
#
# Required variables:
# - FLASHPOINT_HOST_PATH: Path to your Flashpoint installation
# - JWT_SECRET: Secure random string for JWT authentication
#
# Optional variables (with defaults):
# - NODE_ENV, TZ, LOG_LEVEL, WEB_PORT, API_PORT, PROXY_PORT, GAMEZIP_PORT
# - DOMAIN, EXTERNAL_IMAGE_URLS
# =============================================================================
