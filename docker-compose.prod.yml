services:
  # Backend API Service
  backend:
    image: darkraise/flashpoint-backend:latest
    container_name: flashpoint-backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-3100}:3100"
    volumes:
      # Flashpoint data (read-only)
      - ${FLASHPOINT_HOST_PATH:?FLASHPOINT_HOST_PATH environment variable must be set}:/data/flashpoint:ro
      # User database (persistent)
      - backend-db:/app/data
      # Application logs (persistent)
      # Set BACKEND_LOGS_PATH to bind-mount a host directory
      - ${BACKEND_LOGS_PATH:-backend-logs}:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-UTC}
      - PORT=3100
      - HOST=0.0.0.0
      # Flashpoint base path (all other paths derived automatically by backend)
      - FLASHPOINT_PATH=/data/flashpoint
      # Game service connection (Docker network)
      - GAME_SERVICE_HOST=game-service
      - GAME_SERVICE_PROXY_PORT=22500
      - GAME_SERVICE_GAMEZIP_PORT=22501
      # External services
      - EXTERNAL_IMAGE_URLS=${EXTERNAL_IMAGE_URLS:-https://infinity.flashpointarchive.org/Flashpoint/Data/Images,https://infinity.unstable.life/Flashpoint/Data/Images}
      - DOMAIN=${DOMAIN:-http://localhost:${WEB_PORT:-80}}
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET environment variable must be set}
      - USER_DB_PATH=/app/data/user.db
    depends_on:
      game-service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "--fail", "http://localhost:3100/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Game Service (Proxy and ZIP Server)
  game-service:
    image: darkraise/flashpoint-game-service:latest
    container_name: flashpoint-game-service
    restart: unless-stopped
    ports:
      - "${PROXY_PORT:-22500}:22500"
      - "${GAMEZIP_PORT:-22501}:22501"
    volumes:
      - ${FLASHPOINT_HOST_PATH:?FLASHPOINT_HOST_PATH environment variable must be set}:/data/flashpoint:ro
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-UTC}
      - PROXY_PORT=22500
      - GAMEZIPSERVER_PORT=22501
      # Flashpoint base path (all other paths derived automatically)
      - FLASHPOINT_PATH=/data/flashpoint
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
    healthcheck:
      test: [ "CMD", "curl", "--fail", "http://localhost:22500/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend Service (Nginx serving built files)
  frontend:
    image: darkraise/flashpoint-frontend:latest
    container_name: flashpoint-frontend
    restart: unless-stopped
    environment:
      - TZ=${TZ:-UTC}
      - BACKEND_HOST=${BACKEND_HOST:-backend}
      - BACKEND_PORT=${BACKEND_PORT:-3100}
    ports:
      - "${WEB_PORT:-80}:8080"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "--fail", "http://localhost:8080/" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
