# =============================================================================
# Flashpoint Web - Development Docker Compose
# =============================================================================
# Builds images locally from source code.
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d --build
#
# Rebuild specific service:
#   docker compose -f docker-compose.dev.yml up -d --build backend
#
# View logs:
#   docker compose -f docker-compose.dev.yml logs -f
#
# User permissions:
#   Set PUID/PGID to match your host user (run 'id -u' and 'id -g' to find)
#   This ensures bind-mounted volumes have correct ownership
# =============================================================================

services:
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    image: flashpoint-backend:dev
    container_name: flashpoint-backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-3100}:3100"
    volumes:
      - ${FLASHPOINT_HOST_PATH:?FLASHPOINT_HOST_PATH is required}:/data/flashpoint:ro
      - backend-db:/app/data
      - ${LOGS_PATH:-./logs}/backend:/app/logs
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-UTC}
      - GAME_SERVICE_HOST=game-service
      - DOMAIN=${DOMAIN:-http://localhost:${WEB_PORT:-80}}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - ENABLE_LOCAL_DB_COPY=${ENABLE_LOCAL_DB_COPY:-false}
      - SQLITE_CACHE_SIZE=${SQLITE_CACHE_SIZE:--64000}
      - SQLITE_MMAP_SIZE=${SQLITE_MMAP_SIZE:-268435456}
      - ENABLE_CACHE_PREWARM=${ENABLE_CACHE_PREWARM:-true}
      - OTEL_ENABLED=${OTEL_ENABLED:-false}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      - OTEL_API_KEY=${OTEL_API_KEY:-}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-flashpoint-web-backend}
    depends_on:
      game-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3100/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - flashpoint-network

  game-service:
    build:
      context: .
      dockerfile: ./game-service/Dockerfile
    image: flashpoint-game-service:dev
    container_name: flashpoint-game-service
    restart: unless-stopped
    ports:
      - "${PROXY_PORT:-22500}:22500"
      - "${GAMEZIP_PORT:-22501}:22501"
    volumes:
      - ${FLASHPOINT_HOST_PATH:?FLASHPOINT_HOST_PATH is required}:/data/flashpoint:ro
      - ${LOGS_PATH:-./logs}/game-service:/app/logs
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - NODE_ENV=${NODE_ENV:-production}
      - TZ=${TZ:-UTC}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:22500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - flashpoint-network

  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    image: flashpoint-frontend:dev
    container_name: flashpoint-frontend
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-80}:8080"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - BACKEND_HOST=${BACKEND_HOST:-backend}
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - flashpoint-network

networks:
  flashpoint-network:
    driver: bridge

volumes:
  backend-db:
    driver: local
